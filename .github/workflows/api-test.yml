name: API Tests
true:
  workflow_run:
    workflows:
    - Terraform Deploy
    types:
    - completed
  push:
    branches:
    - main
    paths:
    - infras/lambdas/**
    - tests/**
    - .github/workflows/api-test.yml
  workflow_dispatch:
    inputs:
      environment:
        description: Environment to test
        required: true
        default: dev
        type: choice
        options:
        - dev
        - qa
        - prod
permissions:
  id-token: write
  contents: read
  pull-requests: write
env:
  AWS_REGION: us-east-1
  WORKING_DIR: infras/envs/us-east-1
  PYTHON_VERSION: '3.9'
jobs:
  prepare-test:
    name: Prepare Test Environment
    runs-on: ubuntu-latest
    outputs:
      api_endpoint: ${{ steps.get_api_details.outputs.api_endpoint }}
      api_key: ${{ steps.get_api_details.outputs.api_key }}
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
        aws-region: ${{ env.AWS_REGION }}
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    - name: Get API Details
      id: get_api_details
      run: "if [ -f \"${{ env.WORKING_DIR }}/test/api_config.json\" ]; then\n  API_ENDPOINT=$(jq\
        \ -r '.apiEndpoint' \"${{ env.WORKING_DIR }}/test/api_config.json\")\n  API_KEY=$(jq\
        \ -r '.apiKey' \"${{ env.WORKING_DIR }}/test/api_config.json\")\nelse\n  #\
        \ Fallback to fetching from AWS if file doesn't exist\n  ENV_NAME=\"${{ github.event.inputs.environment\
        \ || 'dev' }}\"\n  API_ID=$(aws apigateway get-rest-apis --query \"items[?name=='secure-api-$ENV_NAME'].id\"\
        \ --output text)\n  API_KEYS=$(aws apigateway get-api-keys --include-values\
        \ --query \"items[?name=='cloudable-api-key-$ENV_NAME'].value\" --output text)\n\
        \  \n  API_ENDPOINT=\"https://$API_ID.execute-api.${{ env.AWS_REGION }}.amazonaws.com/$ENV_NAME\"\
        \n  API_KEY=$API_KEYS\nfi\n\necho \"api_endpoint=$API_ENDPOINT\" >> $GITHUB_OUTPUT\n\
        echo \"api_key=$API_KEY\" >> $GITHUB_OUTPUT\n\n# Create environment.json for\
        \ tests\ncat > \"${{ env.WORKING_DIR }}/test/environment.json\" << EOF\n{\n\
        \  \"API_GATEWAY_ID\": \"${API_ID}\",\n  \"API_GATEWAY_STAGE\": \"${{ github.event.inputs.environment\
        \ || 'dev' }}\",\n  \"API_KEY\": \"${API_KEY}\",\n  \"REGION\": \"${{ env.AWS_REGION\
        \ }}\",\n  \"TENANT_ID\": \"t001\",\n  \"CUSTOMER_ID\": \"test_user_$(date\
        \ +%s)\"\n}\nEOF\n"
    - name: Install dependencies
      run: 'python -m pip install --upgrade pip

        pip install boto3 requests pytest pytest-html

        '
  test-kb-query:
    name: Test KB Query API
    needs: prepare-test
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    - name: Install dependencies
      run: 'python -m pip install --upgrade pip

        pip install requests pytest

        '
    - name: Run KB Query Test
      env:
        API_ENDPOINT: ${{ needs.prepare-test.outputs.api_endpoint }}
        API_KEY: ${{ needs.prepare-test.outputs.api_key }}
      run: "cat > test_kb_query.py << 'EOF'\nimport requests\nimport json\nimport\
        \ sys\nimport os\n\nAPI_ENDPOINT = os.environ[\"API_ENDPOINT\"]\nAPI_KEY =\
        \ os.environ[\"API_KEY\"]\n\ndef test_kb_query():\n    url = f\"{API_ENDPOINT}/kb/query\"\
        \n    headers = {\n        \"Content-Type\": \"application/json\",\n     \
        \   \"x-api-key\": API_KEY\n    }\n    payload = {\n        \"tenant_id\"\
        : \"t001\",\n        \"query\": \"What are the AI services offered by AWS?\"\
        \n    }\n    \n    response = requests.post(url, headers=headers, json=payload)\n\
        \    print(f\"Status Code: {response.status_code}\")\n    print(f\"Response:\
        \ {response.text}\")\n    \n    assert response.status_code in [200, 201,\
        \ 202], f\"Expected success status code, got {response.status_code}\"\n  \
        \  \n    try:\n        response_data = response.json()\n        assert \"\
        results\" in response_data, \"Expected 'results' in response\"\n    except\
        \ Exception as e:\n        print(f\"Error parsing response: {e}\")\n     \
        \   sys.exit(1)\n\nif __name__ == \"__main__\":\n    test_kb_query()\nEOF\n\
        \npython test_kb_query.py\n"
  test-chat:
    name: Test Chat API
    needs: prepare-test
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    - name: Install dependencies
      run: 'python -m pip install --upgrade pip

        pip install requests pytest

        '
    - name: Run Chat API Test
      env:
        API_ENDPOINT: ${{ needs.prepare-test.outputs.api_endpoint }}
        API_KEY: ${{ needs.prepare-test.outputs.api_key }}
      run: "cat > test_chat.py << 'EOF'\nimport requests\nimport json\nimport sys\n\
        import os\nimport uuid\n\nAPI_ENDPOINT = os.environ[\"API_ENDPOINT\"]\nAPI_KEY\
        \ = os.environ[\"API_KEY\"]\n\ndef test_chat():\n    url = f\"{API_ENDPOINT}/chat\"\
        \n    headers = {\n        \"Content-Type\": \"application/json\",\n     \
        \   \"x-api-key\": API_KEY\n    }\n    session_id = str(uuid.uuid4())\n  \
        \  payload = {\n        \"tenant_id\": \"t001\",\n        \"customer_id\"\
        : \"test_user\",\n        \"message\": \"What is my journey status?\",\n \
        \       \"session_id\": session_id\n    }\n    \n    response = requests.post(url,\
        \ headers=headers, json=payload)\n    print(f\"Status Code: {response.status_code}\"\
        )\n    print(f\"Response: {response.text}\")\n    \n    assert response.status_code\
        \ in [200, 201, 202], f\"Expected success status code, got {response.status_code}\"\
        \n    \n    try:\n        response_data = response.json()\n        assert\
        \ \"answer\" in response_data, \"Expected 'answer' in response\"\n       \
        \ if \"trace_id\" in response_data:\n            print(f\"Trace ID: {response_data['trace_id']}\"\
        )\n    except Exception as e:\n        print(f\"Error parsing response: {e}\"\
        )\n        sys.exit(1)\n\nif __name__ == \"__main__\":\n    test_chat()\n\
        EOF\n\npython test_chat.py\n"
  generate-test-report:
    name: Generate Test Report
    needs:
    - test-kb-query
    - test-chat
    runs-on: ubuntu-latest
    if: always()
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    - name: Create Test Summary
      run: "echo \"# API Test Results\" > test_summary.md\necho \"\" >> test_summary.md\n\
        echo \"## Test Runs\" >> test_summary.md\necho \"\" >> test_summary.md\necho\
        \ \"| Test | Status |\" >> test_summary.md\necho \"|------|--------|\" >>\
        \ test_summary.md\n\nKB_STATUS=\"${{ needs.test-kb-query.result }}\"\nCHAT_STATUS=\"\
        ${{ needs.test-chat.result }}\"\n\nif [ \"$KB_STATUS\" == \"success\" ]; then\n\
        \  echo \"| KB Query API | \u2705 Passed |\" >> test_summary.md\nelse\n  echo\
        \ \"| KB Query API | \u274C Failed |\" >> test_summary.md\nfi\n\nif [ \"$CHAT_STATUS\"\
        \ == \"success\" ]; then\n  echo \"| Chat API | \u2705 Passed |\" >> test_summary.md\n\
        else\n  echo \"| Chat API | \u274C Failed |\" >> test_summary.md\nfi\n\necho\
        \ \"\" >> test_summary.md\necho \"Test run completed at $(date)\" >> test_summary.md\n"
    - name: Upload Test Summary
      uses: actions/upload-artifact@v3
      with:
        name: test-summary
        path: test_summary.md
        retention-days: 5
  validate-agent-core:
    name: Validate Agent Core
    needs: prepare-test
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
        aws-region: ${{ env.AWS_REGION }}
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    - name: Install dependencies
      run: 'python -m pip install --upgrade pip

        pip install boto3 requests

        '
    - name: Run Agent Core Validation
      run: "cd ${{ env.WORKING_DIR }}\npython validate_agent_core.py --tenant-id t001\
        \ --env ${{ github.event.inputs.environment || 'dev' }}\n\n# Store validation\
        \ result\nif [ $? -eq 0 ]; then\n  echo \"AGENT_CORE_VALIDATION=SUCCESS\"\
        \ >> $GITHUB_ENV\nelse\n  echo \"AGENT_CORE_VALIDATION=FAILURE\" >> $GITHUB_ENV\n\
        fi\n"
    - name: Report Validation Result
      if: env.AGENT_CORE_VALIDATION == 'FAILURE'
      run: 'echo "::error::Agent Core validation failed. Check logs for details."

        exit 1'
'on':
  workflow_dispatch: {}

  workflow_run:
    workflows:
    - Terraform Deploy
    types:
    - completed
  push:
    branches:
    - main
    paths:
    - infras/lambdas/**
    - tests/**
    - .github/workflows/api-test.yml
  workflow_dispatch:
    inputs:
      environment:
        description: Environment to test
        required: true
        default: dev
        type: choice
        options:
        - dev
        - qa
        - prod
permissions:
  id-token: write
  contents: read
  pull-requests: write
env:
  AWS_REGION: us-east-1
  WORKING_DIR: infras/envs/us-east-1
  PYTHON_VERSION: '3.9'
jobs:
  prepare-test:
    name: Prepare Test Environment
    runs-on: ubuntu-latest
    outputs:
      api_endpoint: ${{ steps.get_api_details.outputs.api_endpoint }}
      api_key: ${{ steps.get_api_details.outputs.api_key }}
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
        aws-region: ${{ env.AWS_REGION }}
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    - name: Get API Details
      id: get_api_details
      run: "if [ -f \"${{ env.WORKING_DIR }}/test/api_config.json\" ]; then\n  API_ENDPOINT=$(jq\
        \ -r '.apiEndpoint' \"${{ env.WORKING_DIR }}/test/api_config.json\")\n  API_KEY=$(jq\
        \ -r '.apiKey' \"${{ env.WORKING_DIR }}/test/api_config.json\")\nelse\n  #\
        \ Fallback to fetching from AWS if file doesn't exist\n  ENV_NAME=\"${{ github.event.inputs.environment\
        \ || 'dev' }}\"\n  API_ID=$(aws apigateway get-rest-apis --query \"items[?name=='secure-api-$ENV_NAME'].id\"\
        \ --output text)\n  API_KEYS=$(aws apigateway get-api-keys --include-values\
        \ --query \"items[?name=='cloudable-api-key-$ENV_NAME'].value\" --output text)\n\
        \  \n  API_ENDPOINT=\"https://$API_ID.execute-api.${{ env.AWS_REGION }}.amazonaws.com/$ENV_NAME\"\
        \n  API_KEY=$API_KEYS\nfi\n\necho \"api_endpoint=$API_ENDPOINT\" >> $GITHUB_OUTPUT\n\
        echo \"api_key=$API_KEY\" >> $GITHUB_OUTPUT\n\n# Create environment.json for\
        \ tests\ncat > \"${{ env.WORKING_DIR }}/test/environment.json\" << EOF\n{\n\
        \  \"API_GATEWAY_ID\": \"${API_ID}\",\n  \"API_GATEWAY_STAGE\": \"${{ github.event.inputs.environment\
        \ || 'dev' }}\",\n  \"API_KEY\": \"${API_KEY}\",\n  \"REGION\": \"${{ env.AWS_REGION\
        \ }}\",\n  \"TENANT_ID\": \"t001\",\n  \"CUSTOMER_ID\": \"test_user_$(date\
        \ +%s)\"\n}\nEOF\n"
    - name: Install dependencies
      run: 'python -m pip install --upgrade pip

        pip install boto3 requests pytest pytest-html

        '
  test-kb-query:
    name: Test KB Query API
    needs: prepare-test
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    - name: Install dependencies
      run: 'python -m pip install --upgrade pip

        pip install requests pytest

        '
    - name: Run KB Query Test
      env:
        API_ENDPOINT: ${{ needs.prepare-test.outputs.api_endpoint }}
        API_KEY: ${{ needs.prepare-test.outputs.api_key }}
      run: "cat > test_kb_query.py << 'EOF'\nimport requests\nimport json\nimport\
        \ sys\nimport os\n\nAPI_ENDPOINT = os.environ[\"API_ENDPOINT\"]\nAPI_KEY =\
        \ os.environ[\"API_KEY\"]\n\ndef test_kb_query():\n    url = f\"{API_ENDPOINT}/kb/query\"\
        \n    headers = {\n        \"Content-Type\": \"application/json\",\n     \
        \   \"x-api-key\": API_KEY\n    }\n    payload = {\n        \"tenant_id\"\
        : \"t001\",\n        \"query\": \"What are the AI services offered by AWS?\"\
        \n    }\n    \n    response = requests.post(url, headers=headers, json=payload)\n\
        \    print(f\"Status Code: {response.status_code}\")\n    print(f\"Response:\
        \ {response.text}\")\n    \n    assert response.status_code in [200, 201,\
        \ 202], f\"Expected success status code, got {response.status_code}\"\n  \
        \  \n    try:\n        response_data = response.json()\n        assert \"\
        results\" in response_data, \"Expected 'results' in response\"\n    except\
        \ Exception as e:\n        print(f\"Error parsing response: {e}\")\n     \
        \   sys.exit(1)\n\nif __name__ == \"__main__\":\n    test_kb_query()\nEOF\n\
        \npython test_kb_query.py\n"
  test-chat:
    name: Test Chat API
    needs: prepare-test
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    - name: Install dependencies
      run: 'python -m pip install --upgrade pip

        pip install requests pytest

        '
    - name: Run Chat API Test
      env:
        API_ENDPOINT: ${{ needs.prepare-test.outputs.api_endpoint }}
        API_KEY: ${{ needs.prepare-test.outputs.api_key }}
      run: "cat > test_chat.py << 'EOF'\nimport requests\nimport json\nimport sys\n\
        import os\nimport uuid\n\nAPI_ENDPOINT = os.environ[\"API_ENDPOINT\"]\nAPI_KEY\
        \ = os.environ[\"API_KEY\"]\n\ndef test_chat():\n    url = f\"{API_ENDPOINT}/chat\"\
        \n    headers = {\n        \"Content-Type\": \"application/json\",\n     \
        \   \"x-api-key\": API_KEY\n    }\n    session_id = str(uuid.uuid4())\n  \
        \  payload = {\n        \"tenant_id\": \"t001\",\n        \"customer_id\"\
        : \"test_user\",\n        \"message\": \"What is my journey status?\",\n \
        \       \"session_id\": session_id\n    }\n    \n    response = requests.post(url,\
        \ headers=headers, json=payload)\n    print(f\"Status Code: {response.status_code}\"\
        )\n    print(f\"Response: {response.text}\")\n    \n    assert response.status_code\
        \ in [200, 201, 202], f\"Expected success status code, got {response.status_code}\"\
        \n    \n    try:\n        response_data = response.json()\n        assert\
        \ \"answer\" in response_data, \"Expected 'answer' in response\"\n       \
        \ if \"trace_id\" in response_data:\n            print(f\"Trace ID: {response_data['trace_id']}\"\
        )\n    except Exception as e:\n        print(f\"Error parsing response: {e}\"\
        )\n        sys.exit(1)\n\nif __name__ == \"__main__\":\n    test_chat()\n\
        EOF\n\npython test_chat.py\n"
  generate-test-report:
    name: Generate Test Report
    needs:
    - test-kb-query
    - test-chat
    runs-on: ubuntu-latest
    if: always()
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    - name: Create Test Summary
      run: "echo \"# API Test Results\" > test_summary.md\necho \"\" >> test_summary.md\n\
        echo \"## Test Runs\" >> test_summary.md\necho \"\" >> test_summary.md\necho\
        \ \"| Test | Status |\" >> test_summary.md\necho \"|------|--------|\" >>\
        \ test_summary.md\n\nKB_STATUS=\"${{ needs.test-kb-query.result }}\"\nCHAT_STATUS=\"\
        ${{ needs.test-chat.result }}\"\n\nif [ \"$KB_STATUS\" == \"success\" ]; then\n\
        \  echo \"| KB Query API | \u2705 Passed |\" >> test_summary.md\nelse\n  echo\
        \ \"| KB Query API | \u274C Failed |\" >> test_summary.md\nfi\n\nif [ \"$CHAT_STATUS\"\
        \ == \"success\" ]; then\n  echo \"| Chat API | \u2705 Passed |\" >> test_summary.md\n\
        else\n  echo \"| Chat API | \u274C Failed |\" >> test_summary.md\nfi\n\necho\
        \ \"\" >> test_summary.md\necho \"Test run completed at $(date)\" >> test_summary.md\n"
    - name: Upload Test Summary
      uses: actions/upload-artifact@v3
      with:
        name: test-summary
        path: test_summary.md
        retention-days: 5
  validate-agent-core:
    name: Validate Agent Core
    needs: prepare-test
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
        aws-region: ${{ env.AWS_REGION }}
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    - name: Install dependencies
      run: 'python -m pip install --upgrade pip

        pip install boto3 requests

        '
    - name: Run Agent Core Validation
      run: "cd ${{ env.WORKING_DIR }}\npython validate_agent_core.py --tenant-id t001\
        \ --env ${{ github.event.inputs.environment || 'dev' }}\n\n# Store validation\
        \ result\nif [ $? -eq 0 ]; then\n  echo \"AGENT_CORE_VALIDATION=SUCCESS\"\
        \ >> $GITHUB_ENV\nelse\n  echo \"AGENT_CORE_VALIDATION=FAILURE\" >> $GITHUB_ENV\n\
        fi\n"
    - name: Report Validation Result
      if: env.AGENT_CORE_VALIDATION == 'FAILURE'
      run: 'echo "::error::Agent Core validation failed. Check logs for details."

        exit 1'
'on':
  workflow_dispatch: {}
