name: AWS Resources Setup

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to set up'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - qa
          - prod
      region:
        description: 'AWS Region'
        required: true
        default: 'us-east-1'
        type: string
      state_bucket_name:
        description: 'S3 bucket name for Terraform state'
        required: true
        type: string
      dynamodb_table_name:
        description: 'DynamoDB table name for state locking'
        required: true
        default: 'cloudable-tf-locks'
        type: string

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: ${{ github.event.inputs.region }}
  ENVIRONMENT: ${{ github.event.inputs.environment }}
  STATE_BUCKET: ${{ github.event.inputs.state_bucket_name }}
  DYNAMODB_TABLE: ${{ github.event.inputs.dynamodb_table_name }}

jobs:
  setup-aws-resources:
    name: Set Up AWS Resources
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Create S3 Bucket for Terraform State
        run: |
          # Check if bucket already exists
          if aws s3api head-bucket --bucket ${{ env.STATE_BUCKET }} 2>/dev/null; then
            echo "S3 bucket ${{ env.STATE_BUCKET }} already exists. Skipping creation."
          else
            echo "Creating S3 bucket ${{ env.STATE_BUCKET }}..."
            aws s3api create-bucket \
              --bucket ${{ env.STATE_BUCKET }} \
              --region ${{ env.AWS_REGION }} \
              ${{ env.AWS_REGION != 'us-east-1' && format('--create-bucket-configuration LocationConstraint={0}', env.AWS_REGION) || '' }}
              
            # Enable versioning
            aws s3api put-bucket-versioning \
              --bucket ${{ env.STATE_BUCKET }} \
              --versioning-configuration Status=Enabled
              
            # Enable encryption
            aws s3api put-bucket-encryption \
              --bucket ${{ env.STATE_BUCKET }} \
              --server-side-encryption-configuration '{
                "Rules": [
                  {
                    "ApplyServerSideEncryptionByDefault": {
                      "SSEAlgorithm": "AES256"
                    },
                    "BucketKeyEnabled": true
                  }
                ]
              }'
              
            # Add bucket policy to block public access
            aws s3api put-public-access-block \
              --bucket ${{ env.STATE_BUCKET }} \
              --public-access-block-configuration "BlockPublicAcls=true,IgnorePublicAcls=true,BlockPublicPolicy=true,RestrictPublicBuckets=true"
              
            echo "S3 bucket ${{ env.STATE_BUCKET }} created successfully."
          fi

      - name: Create DynamoDB Table for State Locking
        run: |
          # Check if table already exists
          if aws dynamodb describe-table --table-name ${{ env.DYNAMODB_TABLE }} 2>/dev/null; then
            echo "DynamoDB table ${{ env.DYNAMODB_TABLE }} already exists. Skipping creation."
          else
            echo "Creating DynamoDB table ${{ env.DYNAMODB_TABLE }}..."
            aws dynamodb create-table \
              --table-name ${{ env.DYNAMODB_TABLE }} \
              --attribute-definitions AttributeName=LockID,AttributeType=S \
              --key-schema AttributeName=LockID,KeyType=HASH \
              --billing-mode PAY_PER_REQUEST \
              --tags Key=Environment,Value=${{ env.ENVIRONMENT }}
              
            # Wait for table to be created
            aws dynamodb wait table-exists --table-name ${{ env.DYNAMODB_TABLE }}
            
            echo "DynamoDB table ${{ env.DYNAMODB_TABLE }} created successfully."
          fi

      - name: Update Terraform Backend Configuration
        run: |
          cd infras/envs/us-east-1
          
          cat > backend.tf << EOF
          terraform {
            backend "s3" {
              bucket         = "${{ env.STATE_BUCKET }}"
              key            = "envs/us-east-1/terraform.tfstate"
              region         = "${{ env.AWS_REGION }}"
              dynamodb_table = "${{ env.DYNAMODB_TABLE }}"
              encrypt        = true
            }
          }
          EOF
          
          echo "Terraform backend configuration updated:"
          cat backend.tf

      - name: Commit and Push Backend Configuration
        uses: EndBug/add-and-commit@v9
        with:
          add: 'infras/envs/us-east-1/backend.tf'
          message: 'Update Terraform backend configuration for ${{ env.ENVIRONMENT }} environment'
          default_author: github_actions
          
  configure-iam:
    name: Configure IAM Role for GitHub Actions
    runs-on: ubuntu-latest
    needs: setup-aws-resources
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}
          
      - name: Update IAM Role Permissions
        run: |
          ROLE_NAME=$(echo ${{ secrets.AWS_ROLE_TO_ASSUME }} | awk -F'/' '{print $NF}')
          
          if aws iam get-role --role-name $ROLE_NAME 2>/dev/null; then
            echo "Updating IAM role $ROLE_NAME..."
            
            # Create policy document
            cat > role-policy.json << EOF
            {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "s3:*"
                  ],
                  "Resource": [
                    "arn:aws:s3:::${{ env.STATE_BUCKET }}",
                    "arn:aws:s3:::${{ env.STATE_BUCKET }}/*"
                  ]
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "dynamodb:*"
                  ],
                  "Resource": "arn:aws:dynamodb:${{ env.AWS_REGION }}:*:table/${{ env.DYNAMODB_TABLE }}"
                }
              ]
            }
            EOF
            
            # Attach policy to role
            aws iam put-role-policy \
              --role-name $ROLE_NAME \
              --policy-name TerraformStateAccess \
              --policy-document file://role-policy.json
              
            echo "IAM role policy updated successfully."
          else
            echo "IAM role $ROLE_NAME does not exist. You need to create it manually first."
            echo "Follow the instructions in .github/GITHUB_ACTIONS_SETUP.md to create the role."
            exit 1
          fi
          
  output-next-steps:
    name: Output Next Steps
    runs-on: ubuntu-latest
    needs: [setup-aws-resources, configure-iam]
    steps:
      - name: Display Next Steps
        run: |
          cat << EOF
          #########################################################################
          # AWS Resources Setup Complete                                          #
          #########################################################################
          
          Successfully created/configured:
          - S3 bucket: ${{ env.STATE_BUCKET }} for Terraform state
          - DynamoDB table: ${{ env.DYNAMODB_TABLE }} for state locking
          - Updated IAM role permissions
          - Updated Terraform backend configuration
          
          Next steps:
          
          1. Run the 'Terraform Deploy' workflow with the environment: ${{ env.ENVIRONMENT }}
          
          2. Ensure GitHub Secrets are set:
             - AWS_ROLE_TO_ASSUME: Should already be set
             - LANGFUSE_PUBLIC_KEY: Required for telemetry
             - LANGFUSE_SECRET_KEY: Required for telemetry
          
          #########################################################################
          EOF
