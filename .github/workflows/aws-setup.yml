name: AWS Resources Setup
true:
  workflow_dispatch:
    inputs:
      environment:
        description: Environment to set up
        required: true
        default: dev
        type: choice
        options:
        - dev
        - qa
        - prod
      region:
        description: AWS Region
        required: true
        default: us-east-1
        type: string
      state_bucket_name:
        description: S3 bucket name for Terraform state
        required: true
        type: string
      dynamodb_table_name:
        description: DynamoDB table name for state locking
        required: true
        default: cloudable-tf-locks
        type: string
permissions:
  id-token: write
  contents: read
env:
  AWS_REGION: ${{ github.event.inputs.region }}
  ENVIRONMENT: ${{ github.event.inputs.environment }}
  STATE_BUCKET: ${{ github.event.inputs.state_bucket_name }}
  DYNAMODB_TABLE: ${{ github.event.inputs.dynamodb_table_name }}
jobs:
  setup-aws-resources:
    name: Set Up AWS Resources
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
        aws-region: ${{ env.AWS_REGION }}
    - name: Create S3 Bucket for Terraform State
      run: "# Check if bucket already exists\nif aws s3api head-bucket --bucket ${{\
        \ env.STATE_BUCKET }} 2>/dev/null; then\n  echo \"S3 bucket ${{ env.STATE_BUCKET\
        \ }} already exists. Skipping creation.\"\nelse\n  echo \"Creating S3 bucket\
        \ ${{ env.STATE_BUCKET }}...\"\n  aws s3api create-bucket \\\n    --bucket\
        \ ${{ env.STATE_BUCKET }} \\\n    --region ${{ env.AWS_REGION }} \\\n    ${{\
        \ env.AWS_REGION != 'us-east-1' && format('--create-bucket-configuration LocationConstraint={0}',\
        \ env.AWS_REGION) || '' }}\n    \n  # Enable versioning\n  aws s3api put-bucket-versioning\
        \ \\\n    --bucket ${{ env.STATE_BUCKET }} \\\n    --versioning-configuration\
        \ Status=Enabled\n    \n  # Enable encryption\n  aws s3api put-bucket-encryption\
        \ \\\n    --bucket ${{ env.STATE_BUCKET }} \\\n    --server-side-encryption-configuration\
        \ '{\n      \"Rules\": [\n        {\n          \"ApplyServerSideEncryptionByDefault\"\
        : {\n            \"SSEAlgorithm\": \"AES256\"\n          },\n          \"\
        BucketKeyEnabled\": true\n        }\n      ]\n    }'\n    \n  # Add bucket\
        \ policy to block public access\n  aws s3api put-public-access-block \\\n\
        \    --bucket ${{ env.STATE_BUCKET }} \\\n    --public-access-block-configuration\
        \ \"BlockPublicAcls=true,IgnorePublicAcls=true,BlockPublicPolicy=true,RestrictPublicBuckets=true\"\
        \n    \n  echo \"S3 bucket ${{ env.STATE_BUCKET }} created successfully.\"\
        \nfi\n"
    - name: Create DynamoDB Table for State Locking
      run: "# Check if table already exists\nif aws dynamodb describe-table --table-name\
        \ ${{ env.DYNAMODB_TABLE }} 2>/dev/null; then\n  echo \"DynamoDB table ${{\
        \ env.DYNAMODB_TABLE }} already exists. Skipping creation.\"\nelse\n  echo\
        \ \"Creating DynamoDB table ${{ env.DYNAMODB_TABLE }}...\"\n  aws dynamodb\
        \ create-table \\\n    --table-name ${{ env.DYNAMODB_TABLE }} \\\n    --attribute-definitions\
        \ AttributeName=LockID,AttributeType=S \\\n    --key-schema AttributeName=LockID,KeyType=HASH\
        \ \\\n    --billing-mode PAY_PER_REQUEST \\\n    --tags Key=Environment,Value=${{\
        \ env.ENVIRONMENT }}\n    \n  # Wait for table to be created\n  aws dynamodb\
        \ wait table-exists --table-name ${{ env.DYNAMODB_TABLE }}\n  \n  echo \"\
        DynamoDB table ${{ env.DYNAMODB_TABLE }} created successfully.\"\nfi\n"
    - name: Update Terraform Backend Configuration
      run: "cd infras/envs/us-east-1\n\ncat > backend.tf << EOF\nterraform {\n  backend\
        \ \"s3\" {\n    bucket         = \"${{ env.STATE_BUCKET }}\"\n    key    \
        \        = \"envs/us-east-1/terraform.tfstate\"\n    region         = \"${{\
        \ env.AWS_REGION }}\"\n    dynamodb_table = \"${{ env.DYNAMODB_TABLE }}\"\n\
        \    encrypt        = true\n  }\n}\nEOF\n\necho \"Terraform backend configuration\
        \ updated:\"\ncat backend.tf\n"
    - name: Commit and Push Backend Configuration
      uses: EndBug/add-and-commit@v9
      with:
        add: infras/envs/us-east-1/backend.tf
        message: Update Terraform backend configuration for ${{ env.ENVIRONMENT }}
          environment
        default_author: github_actions
  configure-iam:
    name: Configure IAM Role for GitHub Actions
    runs-on: ubuntu-latest
    needs: setup-aws-resources
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
        aws-region: ${{ env.AWS_REGION }}
    - name: Update IAM Role Permissions
      run: "ROLE_NAME=$(echo ${{ secrets.AWS_ROLE_TO_ASSUME }} | awk -F'/' '{print\
        \ $NF}')\n\nif aws iam get-role --role-name $ROLE_NAME 2>/dev/null; then\n\
        \  echo \"Updating IAM role $ROLE_NAME...\"\n  \n  # Create policy document\n\
        \  cat > role-policy.json << EOF\n  {\n    \"Version\": \"2012-10-17\",\n\
        \    \"Statement\": [\n      {\n        \"Effect\": \"Allow\",\n        \"\
        Action\": [\n          \"s3:*\"\n        ],\n        \"Resource\": [\n   \
        \       \"arn:aws:s3:::${{ env.STATE_BUCKET }}\",\n          \"arn:aws:s3:::${{\
        \ env.STATE_BUCKET }}/*\"\n        ]\n      },\n      {\n        \"Effect\"\
        : \"Allow\",\n        \"Action\": [\n          \"dynamodb:*\"\n        ],\n\
        \        \"Resource\": \"arn:aws:dynamodb:${{ env.AWS_REGION }}:*:table/${{\
        \ env.DYNAMODB_TABLE }}\"\n      }\n    ]\n  }\n  EOF\n  \n  # Attach policy\
        \ to role\n  aws iam put-role-policy \\\n    --role-name $ROLE_NAME \\\n \
        \   --policy-name TerraformStateAccess \\\n    --policy-document file://role-policy.json\n\
        \    \n  echo \"IAM role policy updated successfully.\"\nelse\n  echo \"IAM\
        \ role $ROLE_NAME does not exist. You need to create it manually first.\"\n\
        \  echo \"Follow the instructions in .github/GITHUB_ACTIONS_SETUP.md to create\
        \ the role.\"\n  exit 1\nfi\n"
  output-next-steps:
    name: Output Next Steps
    runs-on: ubuntu-latest
    needs:
    - setup-aws-resources
    - configure-iam
    steps:
    - name: Display Next Steps
      run: "cat << EOF\n#########################################################################\n\
        # AWS Resources Setup Complete                                          #\n\
        #########################################################################\n\
        \nSuccessfully created/configured:\n- S3 bucket: ${{ env.STATE_BUCKET }} for\
        \ Terraform state\n- DynamoDB table: ${{ env.DYNAMODB_TABLE }} for state locking\n\
        - Updated IAM role permissions\n- Updated Terraform backend configuration\n\
        \nNext steps:\n\n1. Run the 'Terraform Deploy' workflow with the environment:\
        \ ${{ env.ENVIRONMENT }}\n\n2. Ensure GitHub Secrets are set:\n   - AWS_ROLE_TO_ASSUME:\
        \ Should already be set\n   - LANGFUSE_PUBLIC_KEY: Required for telemetry\n\
        \   - LANGFUSE_SECRET_KEY: Required for telemetry\n\n#########################################################################\n\
        EOF\n"
'on':
  workflow_dispatch: {}
true:
  workflow_dispatch:
    inputs:
      environment:
        description: Environment to set up
        required: true
        default: dev
        type: choice
        options:
        - dev
        - qa
        - prod
      region:
        description: AWS Region
        required: true
        default: us-east-1
        type: string
      state_bucket_name:
        description: S3 bucket name for Terraform state
        required: true
        type: string
      dynamodb_table_name:
        description: DynamoDB table name for state locking
        required: true
        default: cloudable-tf-locks
        type: string
permissions:
  id-token: write
  contents: read
env:
  AWS_REGION: ${{ github.event.inputs.region }}
  ENVIRONMENT: ${{ github.event.inputs.environment }}
  STATE_BUCKET: ${{ github.event.inputs.state_bucket_name }}
  DYNAMODB_TABLE: ${{ github.event.inputs.dynamodb_table_name }}
jobs:
  setup-aws-resources:
    name: Set Up AWS Resources
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
        aws-region: ${{ env.AWS_REGION }}
    - name: Create S3 Bucket for Terraform State
      run: "# Check if bucket already exists\nif aws s3api head-bucket --bucket ${{\
        \ env.STATE_BUCKET }} 2>/dev/null; then\n  echo \"S3 bucket ${{ env.STATE_BUCKET\
        \ }} already exists. Skipping creation.\"\nelse\n  echo \"Creating S3 bucket\
        \ ${{ env.STATE_BUCKET }}...\"\n  aws s3api create-bucket \\\n    --bucket\
        \ ${{ env.STATE_BUCKET }} \\\n    --region ${{ env.AWS_REGION }} \\\n    ${{\
        \ env.AWS_REGION != 'us-east-1' && format('--create-bucket-configuration LocationConstraint={0}',\
        \ env.AWS_REGION) || '' }}\n    \n  # Enable versioning\n  aws s3api put-bucket-versioning\
        \ \\\n    --bucket ${{ env.STATE_BUCKET }} \\\n    --versioning-configuration\
        \ Status=Enabled\n    \n  # Enable encryption\n  aws s3api put-bucket-encryption\
        \ \\\n    --bucket ${{ env.STATE_BUCKET }} \\\n    --server-side-encryption-configuration\
        \ '{\n      \"Rules\": [\n        {\n          \"ApplyServerSideEncryptionByDefault\"\
        : {\n            \"SSEAlgorithm\": \"AES256\"\n          },\n          \"\
        BucketKeyEnabled\": true\n        }\n      ]\n    }'\n    \n  # Add bucket\
        \ policy to block public access\n  aws s3api put-public-access-block \\\n\
        \    --bucket ${{ env.STATE_BUCKET }} \\\n    --public-access-block-configuration\
        \ \"BlockPublicAcls=true,IgnorePublicAcls=true,BlockPublicPolicy=true,RestrictPublicBuckets=true\"\
        \n    \n  echo \"S3 bucket ${{ env.STATE_BUCKET }} created successfully.\"\
        \nfi\n"
    - name: Create DynamoDB Table for State Locking
      run: "# Check if table already exists\nif aws dynamodb describe-table --table-name\
        \ ${{ env.DYNAMODB_TABLE }} 2>/dev/null; then\n  echo \"DynamoDB table ${{\
        \ env.DYNAMODB_TABLE }} already exists. Skipping creation.\"\nelse\n  echo\
        \ \"Creating DynamoDB table ${{ env.DYNAMODB_TABLE }}...\"\n  aws dynamodb\
        \ create-table \\\n    --table-name ${{ env.DYNAMODB_TABLE }} \\\n    --attribute-definitions\
        \ AttributeName=LockID,AttributeType=S \\\n    --key-schema AttributeName=LockID,KeyType=HASH\
        \ \\\n    --billing-mode PAY_PER_REQUEST \\\n    --tags Key=Environment,Value=${{\
        \ env.ENVIRONMENT }}\n    \n  # Wait for table to be created\n  aws dynamodb\
        \ wait table-exists --table-name ${{ env.DYNAMODB_TABLE }}\n  \n  echo \"\
        DynamoDB table ${{ env.DYNAMODB_TABLE }} created successfully.\"\nfi\n"
    - name: Update Terraform Backend Configuration
      run: "cd infras/envs/us-east-1\n\ncat > backend.tf << EOF\nterraform {\n  backend\
        \ \"s3\" {\n    bucket         = \"${{ env.STATE_BUCKET }}\"\n    key    \
        \        = \"envs/us-east-1/terraform.tfstate\"\n    region         = \"${{\
        \ env.AWS_REGION }}\"\n    dynamodb_table = \"${{ env.DYNAMODB_TABLE }}\"\n\
        \    encrypt        = true\n  }\n}\nEOF\n\necho \"Terraform backend configuration\
        \ updated:\"\ncat backend.tf\n"
    - name: Commit and Push Backend Configuration
      uses: EndBug/add-and-commit@v9
      with:
        add: infras/envs/us-east-1/backend.tf
        message: Update Terraform backend configuration for ${{ env.ENVIRONMENT }}
          environment
        default_author: github_actions
  configure-iam:
    name: Configure IAM Role for GitHub Actions
    runs-on: ubuntu-latest
    needs: setup-aws-resources
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
        aws-region: ${{ env.AWS_REGION }}
    - name: Update IAM Role Permissions
      run: "ROLE_NAME=$(echo ${{ secrets.AWS_ROLE_TO_ASSUME }} | awk -F'/' '{print\
        \ $NF}')\n\nif aws iam get-role --role-name $ROLE_NAME 2>/dev/null; then\n\
        \  echo \"Updating IAM role $ROLE_NAME...\"\n  \n  # Create policy document\n\
        \  cat > role-policy.json << EOF\n  {\n    \"Version\": \"2012-10-17\",\n\
        \    \"Statement\": [\n      {\n        \"Effect\": \"Allow\",\n        \"\
        Action\": [\n          \"s3:*\"\n        ],\n        \"Resource\": [\n   \
        \       \"arn:aws:s3:::${{ env.STATE_BUCKET }}\",\n          \"arn:aws:s3:::${{\
        \ env.STATE_BUCKET }}/*\"\n        ]\n      },\n      {\n        \"Effect\"\
        : \"Allow\",\n        \"Action\": [\n          \"dynamodb:*\"\n        ],\n\
        \        \"Resource\": \"arn:aws:dynamodb:${{ env.AWS_REGION }}:*:table/${{\
        \ env.DYNAMODB_TABLE }}\"\n      }\n    ]\n  }\n  EOF\n  \n  # Attach policy\
        \ to role\n  aws iam put-role-policy \\\n    --role-name $ROLE_NAME \\\n \
        \   --policy-name TerraformStateAccess \\\n    --policy-document file://role-policy.json\n\
        \    \n  echo \"IAM role policy updated successfully.\"\nelse\n  echo \"IAM\
        \ role $ROLE_NAME does not exist. You need to create it manually first.\"\n\
        \  echo \"Follow the instructions in .github/GITHUB_ACTIONS_SETUP.md to create\
        \ the role.\"\n  exit 1\nfi\n"
  output-next-steps:
    name: Output Next Steps
    runs-on: ubuntu-latest
    needs:
    - setup-aws-resources
    - configure-iam
    steps:
    - name: Display Next Steps
      run: "cat << EOF\n#########################################################################\n\
        # AWS Resources Setup Complete                                          #\n\
        #########################################################################\n\
        \nSuccessfully created/configured:\n- S3 bucket: ${{ env.STATE_BUCKET }} for\
        \ Terraform state\n- DynamoDB table: ${{ env.DYNAMODB_TABLE }} for state locking\n\
        - Updated IAM role permissions\n- Updated Terraform backend configuration\n\
        \nNext steps:\n\n1. Run the 'Terraform Deploy' workflow with the environment:\
        \ ${{ env.ENVIRONMENT }}\n\n2. Ensure GitHub Secrets are set:\n   - AWS_ROLE_TO_ASSUME:\
        \ Should already be set\n   - LANGFUSE_PUBLIC_KEY: Required for telemetry\n\
        \   - LANGFUSE_SECRET_KEY: Required for telemetry\n\n#########################################################################\n\
        EOF\n"
'on':
  workflow_dispatch: {}
